{
  "id": "aspnet-request-context",
  "name": "ASP.NET Request Context",
  "description": "Enrich .NET backend events with ASP.NET-specific request context (controller, action, route data, claims)",
  "sdk": "dotnet",
  "event": {
    "event_id": "aspnet-context-999",
    "message": "Database query timeout in OrdersController",
    "exception": {
      "values": [
        {
          "type": "SqlException",
          "value": "Timeout expired. The timeout period elapsed prior to completion of the operation"
        }
      ]
    },
    "request": {
      "url": "https://api.example.com/api/orders/123",
      "method": "GET"
    }
  },
  "beforeSendCode": "using Sentry;\nusing Microsoft.AspNetCore.Http;\nusing Microsoft.AspNetCore.Routing;\nusing System.Security.Claims;\n\npublic class AspNetContextEnricher\n{\n    private readonly IHttpContextAccessor _httpContextAccessor;\n\n    public AspNetContextEnricher(IHttpContextAccessor httpContextAccessor)\n    {\n        _httpContextAccessor = httpContextAccessor;\n    }\n\n    public SentryEvent BeforeSend(SentryEvent ev)\n    {\n        var httpContext = _httpContextAccessor.HttpContext;\n        if (httpContext == null) return ev;\n\n        // Add controller and action information\n        var routeData = httpContext.GetRouteData();\n        if (routeData != null)\n        {\n            var controller = routeData.Values[\"controller\"]?.ToString();\n            var action = routeData.Values[\"action\"]?.ToString();\n            var area = routeData.Values[\"area\"]?.ToString();\n\n            if (!string.IsNullOrEmpty(controller))\n            {\n                ev.SetTag(\"controller\", controller);\n                ev.SetExtra(\"mvc.controller\", controller);\n            }\n\n            if (!string.IsNullOrEmpty(action))\n            {\n                ev.SetTag(\"action\", action);\n                ev.SetExtra(\"mvc.action\", action);\n            }\n\n            if (!string.IsNullOrEmpty(area))\n            {\n                ev.SetTag(\"area\", area);\n                ev.SetExtra(\"mvc.area\", area);\n            }\n\n            // Add route parameters\n            var routeParams = new Dictionary<string, string>();\n            foreach (var value in routeData.Values)\n            {\n                if (value.Key != \"controller\" && value.Key != \"action\" && value.Key != \"area\")\n                {\n                    routeParams[value.Key] = value.Value?.ToString() ?? \"\";\n                }\n            }\n            if (routeParams.Any())\n            {\n                ev.SetExtra(\"route_parameters\", routeParams);\n            }\n        }\n\n        // Add user claims (without PII)\n        var user = httpContext.User;\n        if (user?.Identity?.IsAuthenticated == true)\n        {\n            ev.SetExtra(\"user.authenticated\", true);\n            ev.SetExtra(\"user.authentication_type\", user.Identity.AuthenticationType);\n\n            // Add non-PII claims\n            var claims = new Dictionary<string, string>();\n            foreach (var claim in user.Claims)\n            {\n                // Only include safe claims, skip PII like email, name\n                if (claim.Type == ClaimTypes.Role)\n                {\n                    claims[\"role\"] = claim.Value;\n                    ev.SetTag(\"user_role\", claim.Value);\n                }\n                else if (claim.Type == \"tenant_id\")\n                {\n                    claims[\"tenant_id\"] = claim.Value;\n                    ev.SetTag(\"tenant\", claim.Value);\n                }\n                else if (claim.Type == \"subscription_tier\")\n                {\n                    claims[\"subscription_tier\"] = claim.Value;\n                    ev.SetTag(\"subscription\", claim.Value);\n                }\n            }\n            if (claims.Any())\n            {\n                ev.SetExtra(\"user_claims\", claims);\n            }\n        }\n\n        // Add request metadata\n        ev.SetExtra(\"request.protocol\", httpContext.Request.Protocol);\n        ev.SetExtra(\"request.scheme\", httpContext.Request.Scheme);\n        ev.SetExtra(\"request.host\", httpContext.Request.Host.ToString());\n        ev.SetExtra(\"request.path\", httpContext.Request.Path.ToString());\n        ev.SetExtra(\"request.query_string\", httpContext.Request.QueryString.ToString());\n        ev.SetExtra(\"request.content_type\", httpContext.Request.ContentType);\n        ev.SetExtra(\"request.content_length\", httpContext.Request.ContentLength);\n\n        // Add response metadata\n        ev.SetExtra(\"response.status_code\", httpContext.Response.StatusCode);\n        ev.SetExtra(\"response.content_type\", httpContext.Response.ContentType);\n\n        // Add connection info\n        ev.SetExtra(\"connection.remote_ip\", httpContext.Connection.RemoteIpAddress?.ToString());\n        ev.SetExtra(\"connection.remote_port\", httpContext.Connection.RemotePort);\n        ev.SetExtra(\"connection.local_ip\", httpContext.Connection.LocalIpAddress?.ToString());\n        ev.SetExtra(\"connection.local_port\", httpContext.Connection.LocalPort);\n\n        // Add feature context (if using feature flags)\n        ev.SetExtra(\"features.enabled\", new string[]\n        {\n            \"new_checkout_flow\",\n            \"enhanced_logging\",\n            \"cache_optimization\"\n        });\n\n        // Add performance metrics\n        ev.SetTag(\"api_version\", \"v2\");\n        ev.SetTag(\"environment\", Environment.GetEnvironmentVariable(\"ASPNETCORE_ENVIRONMENT\") ?? \"production\");\n\n        return ev;\n    }\n}"
}

{
  "id": "ios-lifecycle-tags",
  "name": "iOS Lifecycle & App State Tags",
  "description": "Add iOS-specific lifecycle events, memory warnings, and app state transition context for mobile debugging",
  "sdk": "cocoa",
  "event": {
    "event_id": "ios-lifecycle-111",
    "message": "Memory warning received during video processing",
    "exception": {
      "values": [
        {
          "type": "NSException",
          "value": "Memory pressure - app received didReceiveMemoryWarning"
        }
      ]
    },
    "contexts": {
      "device": {
        "name": "iPhone 14 Pro Max",
        "model": "iPhone15,3"
      },
      "os": {
        "name": "iOS",
        "version": "17.3"
      },
      "app": {
        "app_version": "3.1.0",
        "app_build": "245"
      }
    }
  },
  "beforeSendCode": "// Add app lifecycle state\nif (!event.tags) event.tags = {};\nif (!event.extra) event.extra = {};\n\n// Determine current app state\nconst appState = UIApplication.shared.applicationState;\nlet appStateStr = \"unknown\";\nswitch (appState) {\n    case UIApplication.State.active:\n        appStateStr = \"active\";\n        break;\n    case UIApplication.State.inactive:\n        appStateStr = \"inactive\";\n        break;\n    case UIApplication.State.background:\n        appStateStr = \"background\";\n        break;\n}\n\nevent.tags.app_state = appStateStr;\nevent.extra.app_lifecycle_state = appStateStr;\n\n// Add app state transition context\nevent.extra.time_in_foreground = ProcessInfo.processInfo.systemUptime - appLaunchTime; // seconds\nevent.extra.background_time_remaining = UIApplication.shared.backgroundTimeRemaining;\n\n// Memory warnings context\nevent.tags.memory_warning = \"true\";\nevent.extra.memory_warning_count = memoryWarningCount; // Track in app delegate\nevent.extra.memory_footprint_mb = getMemoryFootprint() / (1024 * 1024);\n\n// Low power mode detection\nif (ProcessInfo.processInfo.isLowPowerModeEnabled) {\n    event.tags.low_power_mode = \"enabled\";\n    event.extra.low_power_mode = true;\n}\n\n// Background fetch status\nconst backgroundRefreshStatus = UIApplication.shared.backgroundRefreshStatus;\nlet refreshStatusStr = \"unknown\";\nswitch (backgroundRefreshStatus) {\n    case UIBackgroundRefreshStatus.available:\n        refreshStatusStr = \"available\";\n        break;\n    case UIBackgroundRefreshStatus.denied:\n        refreshStatusStr = \"denied\";\n        break;\n    case UIBackgroundRefreshStatus.restricted:\n        refreshStatusStr = \"restricted\";\n        break;\n}\nevent.extra.background_refresh_status = refreshStatusStr;\n\n// Scene lifecycle (iOS 13+)\nif (activeScene) {\n    event.extra.scene_activation_state = activeScene.activationState;\n    event.extra.scene_session_role = activeScene.session.role;\n}\n\n// Extension context (if running in app extension)\nif (isAppExtension) {\n    event.tags.app_extension = \"true\";\n    event.extra.extension_type = extensionType; // \"widget\", \"share\", \"today\", etc.\n}\n\n// App launch context\nevent.extra.launch_options = {\n    launched_from_url: launchOptions?.url != null,\n    launched_from_notification: launchOptions?.remoteNotification != null,\n    launched_from_shortcut: launchOptions?.shortcutItem != null\n};\n\n// Thermal state\nconst thermalState = ProcessInfo.processInfo.thermalState;\nlet thermalStateStr = \"nominal\";\nswitch (thermalState) {\n    case ProcessInfo.ThermalState.nominal:\n        thermalStateStr = \"nominal\";\n        break;\n    case ProcessInfo.ThermalState.fair:\n        thermalStateStr = \"fair\";\n        break;\n    case ProcessInfo.ThermalState.serious:\n        thermalStateStr = \"serious\";\n        break;\n    case ProcessInfo.ThermalState.critical:\n        thermalStateStr = \"critical\";\n        break;\n}\nevent.extra.thermal_state = thermalStateStr;\nif (thermalState >= ProcessInfo.ThermalState.serious) {\n    event.tags.thermal_throttling = \"true\";\n}\n\n// View controller context\nif (currentViewController) {\n    event.extra.current_view_controller = String(describing: type(of: currentViewController));\n    event.extra.view_controller_hierarchy = getViewControllerHierarchy();\n}\n\n// App version and build\nevent.tags.app_version = Bundle.main.infoDictionary?[\"CFBundleShortVersionString\"] as? String ?? \"unknown\";\nevent.tags.build_number = Bundle.main.infoDictionary?[\"CFBundleVersion\"] as? String ?? \"unknown\";\n\n// Debug/TestFlight/AppStore detection\nif (isDebugBuild) {\n    event.tags.build_type = \"debug\";\n} else if (isTestFlightBuild) {\n    event.tags.build_type = \"testflight\";\n} else {\n    event.tags.build_type = \"appstore\";\n}\n\n// Add task identifier for background tasks\nif (appState === UIApplication.State.background && currentBackgroundTask) {\n    event.extra.background_task_id = currentBackgroundTask;\n}\n\nreturn event;"
}

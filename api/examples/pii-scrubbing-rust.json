{
  "id": "pii-scrubbing-rust",
  "name": "PII Scrubbing (Rust)",
  "description": "Remove sensitive data (emails, API keys, tokens) from Rust error events before sending to Sentry",
  "type": "beforeSend",
  "sdk": "rust",
  "event": {
    "event_id": "rust-pii-456",
    "message": "Authentication failed",
    "exception": {
      "values": [
        {
          "type": "AuthError",
          "value": "Invalid API key: sk_live_abc123xyz"
        }
      ]
    },
    "extra": {
      "user_email": "user@example.com",
      "api_key": "sk_live_abc123xyz",
      "session_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"
    },
    "user": {
      "email": "user@example.com",
      "ip_address": "192.168.1.100"
    }
  },
  "beforeSendCode": "use serde_json::Value;\n\n// Helper to redact string fields\nfn redact_string(text: &str) -> String {\n    if text.len() <= 4 {\n        \"[REDACTED]\".to_string()\n    } else {\n        format!(\"{}****\", &text[..4])\n    }\n}\n\n// Redact email addresses\nif let Some(user) = event.get_mut(\"user\") {\n    if let Some(email) = user.get(\"email\") {\n        if let Some(email_str) = email.as_str() {\n            user[\"email\"] = Value::String(redact_string(email_str));\n        }\n    }\n    // Remove IP addresses\n    if user.as_object()?.contains_key(\"ip_address\") {\n        user.as_object_mut()?.remove(\"ip_address\");\n    }\n}\n\n// Redact sensitive extra data\nif let Some(extra) = event.get_mut(\"extra\") {\n    if extra.get(\"api_key\").is_some() {\n        extra[\"api_key\"] = Value::String(\"[REDACTED]\".to_string());\n    }\n    if extra.get(\"session_token\").is_some() {\n        extra[\"session_token\"] = Value::String(\"[REDACTED]\".to_string());\n    }\n    if let Some(email) = extra.get(\"user_email\") {\n        if let Some(email_str) = email.as_str() {\n            extra[\"user_email\"] = Value::String(redact_string(email_str));\n        }\n    }\n}\n\n// Scrub exception messages\nif let Some(exception) = event.get_mut(\"exception\") {\n    if let Some(values) = exception.get_mut(\"values\") {\n        if let Some(arr) = values.as_array_mut() {\n            for exc in arr {\n                if let Some(value) = exc.get(\"value\") {\n                    if let Some(msg) = value.as_str() {\n                        // Replace API keys in error messages\n                        let cleaned = msg.replace(\"sk_live_abc123xyz\", \"[REDACTED_KEY]\");\n                        exc[\"value\"] = Value::String(cleaned);\n                    }\n                }\n            }\n        }\n    }\n}\n\nSome(event)"
}
